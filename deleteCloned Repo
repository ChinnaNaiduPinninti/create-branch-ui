const express = require('express');
const cors = require('cors');
const { exec } = require('child_process');
const bodyParser = require('body-parser');

const app = express();
const port = 3006;
app.use(cors());

const corsOptions = {
  origin: 'http://myazedlap0010.aiaazure.biz:3006', // Replace with your frontend's URL
  methods: 'POST',
  allowedHeaders: 'Content-Type',
};

// Handle pre-flight requests for all routes
app.options('*', cors(corsOptions));

app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static(__dirname + '/public'));
app.use(bodyParser.json());

const fs = require('fs').promises; // Use promises-based filesystem module

app.post('/deleteClonedRepo', (req, res) => {
  const requestBody = req.body;
  console.log(requestBody);
  const projectName = req.body.projectName;

  const filePath = `/opt/wm/node/projectNames/${projectName}.txt`;

  // Read the file
  fs.readFile(filePath, 'utf8')
    .then((data) => {
      // Now, 'data' contains the contents of the file.
      // You can perform your operations on it here.
      console.log('File data:', data);

      // Example: Split the file contents by lines
      const lines = data.split('\n');
      console.log('File lines:', lines);

      // Example: Process each line
      const deletionPromises = lines.map((line, index) => {
        console.log(`Line ${index + 1}: ${line.trim()}`);
        if (line.trim() !== '') {
          // Copy the server name from the line
          serverName = line.trim();
          const folderPath = `/opt/wm/git/${serverName}_${projectName}`;
          console.log('Server Name:', serverName);

          // Use try-catch to handle folder deletion
          return fs.rm(folderPath, { recursive: true })
            .then(() => {
              console.log(`Folder ${folderPath} deleted successfully.`);
            })
            .catch((error) => {
              console.error(`Error deleting folder: ${error.message}`);
            });
        }
      });

      // Wait for all deletion promises to complete
      return Promise.all(deletionPromises);
    })
    .then(() => {
      res.json({ message: 'Folders deleted successfully' });
    })
    .catch((error) => {
      console.error(`Error reading the file: ${error.message}`);
      res.status(500).json({ error: 'Failed to read the file' });
    });
});

app.listen(port, () => {
  console.log(`Node.js server listening on port ${port}`);
});
